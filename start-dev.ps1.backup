param()

Write-Host "Starting development servers..." -ForegroundColor Green
Write-Host ""

$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$venvPath = Join-Path (Split-Path $scriptDir -Parent) ".venv\Scripts\Activate.ps1"
$backendPath = Join-Path $scriptDir "backend-api"
$frontendPath = Join-Path $scriptDir "frontend\ai-receipt-ui"

if (-not (Test-Path $venvPath)) {
    Write-Host "ERROR: Virtual environment not found" -ForegroundColor Red
    exit 1
}

if (-not (Test-Path $backendPath)) {
    Write-Host "ERROR: Backend directory not found" -ForegroundColor Red
    exit 1
}

Write-Host "Checking dependencies..." -ForegroundColor Gray
$pythonExe = Join-Path (Split-Path $scriptDir -Parent) ".venv\Scripts\python.exe"
$requirementsPath = Join-Path $backendPath "requirements.txt"

if (Test-Path $requirementsPath) {
    $result = & $pythonExe -c "try: from app import create_app; print('OK')" 2>&1
    if ($result -notmatch "OK") {
        Write-Host "Installing missing dependencies..." -ForegroundColor Yellow
        Push-Location $backendPath
        & $pythonExe -m pip install -q -r requirements.txt
        Pop-Location
        Write-Host "Done" -ForegroundColor Green
    }
}

$portInUse = Get-NetTCPConnection -LocalPort 5000 -ErrorAction SilentlyContinue
if ($portInUse) {
    Write-Host "Clearing port 5000..." -ForegroundColor Yellow
    $procs = $portInUse | Select-Object -ExpandProperty OwningProcess -Unique | Where-Object { $_ -ne 0 }
    foreach ($p in $procs) {
        Stop-Process -Id $p -Force -ErrorAction SilentlyContinue
    }
    Start-Sleep -Seconds 1
}

Write-Host "Launching Backend API..." -ForegroundColor Cyan
Start-Process powershell -ArgumentList "-NoExit","-Command","cd '$backendPath'; & '$venvPath'; python run.py"

Start-Sleep -Seconds 3

Write-Host "Launching Frontend..." -ForegroundColor Cyan
Start-Process powershell -ArgumentList "-NoExit","-Command","cd '$frontendPath'; npm run dev"

Write-Host ""
Write-Host "Development servers started!" -ForegroundColor Green
Write-Host "Backend: http://localhost:5000" -ForegroundColor Yellow
Write-Host "Frontend: http://localhost:5173" -ForegroundColor Yellow
Write-Host ""

